}
mean <- matrix(ncol= ncol(range1),
nrow = nrow(range1)/3)
# mean <- as.data.frame(mean)
colnames(mean) <- colnames(range1)
rownames(mean) <- search.vector
for(j in 1:length(colnames(range1))){
for(i in 1:length(rownames(mean))){
mean[i,j] <- mean(c(range1[index[[i]][1],j],
range1[index[[i]][2],j],
range1[index[[i]][3],j]
) )
}
}
mean <- as.data.frame(mean)
cols.means <- as.factor(search.vector)
for(i in  1:length(rownames(mean))){
plot(wavenumbers1,
mean[i,],
axes = F,
xlab = '',
ylab = '',
xlim = c(1700, 400),
ylim= c(0,0.2),
type = 'l',
col =cols.means[i]
)
par(new = T)
}
box()
axis(1)
axis(2)
title(main = 'averaged spectra',
xlab = expression(paste('Wave number (cm'^'-1',')')),
ylab ='absorbance (a.u.)')
library(hyperSpec)
spc <- new('hyperSpec',
spc= mean,
wavelength = wavenumbers1)
bend <- 0.1 * wl.eval(spc,
function (x) x^6+x^5+x^4+x^3+x^2,
normalize.wl = normalize01)
bl <- spc.rubberband(spc+bend, noise = 1e-4, df = 20)-bend
suma <- spc+bend
spc3 <- spc - bl
plot(spc, wl.reverse = TRUE)
plot(bl, add=TRUE, col=2,wl.reverse = TRUE)
plot(suma,wl.reverse = TRUE)
plot(bend, add=TRUE, col=2,wl.reverse = TRUE)
plot(spc3,wl.reverse = TRUE)
corrected1  <- as.data.frame(spc3[1:106])
corrected <- as.data.frame(corrected1[,1])
corrected <- corrected + (min(corrected)*-1) # shifting upwards to prevent negative values
# par(mfrow = c(2,2))
#
# for(i in  1:length(rownames(spectra.df))){
#
#   plot(wavenumbers,
#     spectra.df[i,],
#     axes = F,
#     xlab = '',
#     ylab = '',
#     xlim = c(4000, 400),
#     ylim= c(0,0.2),
#     type = 'l',
#     col =cols[i]
#
#   )
#   par(new = T)
# }
#
# box()
# axis(1)
# axis(2)
# title(main = 'raw spectra full range',
#       xlab = expression(paste('Wave number (cm'^'-1',')')),
#       ylab ='absorbance (a.u.)')
#
# for(i in  1:length(rownames(range1))){
#
#   plot(wavenumbers1,
#     range1[i,],
#     axes = F,
#     xlab = '',
#     ylab = '',
#     xlim = c(1700, 400),
#     ylim= c(0,0.2),
#     type = 'l',
#     col =cols[i]
#
#   )
#   par(new = T)
# }
#
# box()
# axis(1)
# axis(2)
# title(main = 'raw spectra - ROI',
#       xlab = expression(paste('Wave number (cm'^'-1',')')),
#       ylab ='absorbance (a.u.)')
#
#
# for(i in  1:length(rownames(mean))){
#
#   plot(wavenumbers1,
#     mean[i,],
#     axes = F,
#     xlab = '',
#     ylab = '',
#     xlim = c(1700, 400),
#     ylim= c(0,0.2),
#     type = 'l',
#     col =cols.means[i]
#
#   )
#   par(new = T)
# }
#
# box()
# axis(1)
# axis(2)
# title(main = 'averaged spectra',
#       xlab = expression(paste('Wave number (cm'^'-1',')')),
#       ylab ='absorbance (a.u.)')
#
# for(i in  1:length(rownames(mean))){
#
#   plot(wavenumbers1,
#     corrected[i,],
#     axes = F,
#     xlab = '',
#     ylab = '',
#     xlim = c(1700, 400),
#     ylim= c(0,0.1),
#     type = 'l',
#     col =cols.means[i]
#
#   )
#   par(new = T)
# }
#
# box()
# axis(1)
# axis(2)
# title(main = 'corrected spectra',
#       xlab = expression(paste('Wave number (cm'^'-1',')')),
#       ylab ='absorbance (a.u.)')
library(readxl)
metadata <- read_excel("metadata.xlsx")
which(is.na(metadata$sample))
metadata <- metadata[-c(17),]
which(is.na(metadata$sample))
positions <- vector('list', 87) # the same sizeas metadata$sample
for (i in 1:87){
positions[[i]] <- which(grepl(paste0('(?=.*',as.character(metadata$sample[i]),')'),rownames(corrected), perl=T))
}
metadata$sample[1]
rownames(corrected)[positions[[1]]]
for(i in 1:length(metadata$sample)) {
if(length(positions[[i]]) == 1){
metadata$spectra[i] <- rownames(corrected)[positions[[i]]]
}else{
metadata$spectra[i] <- NA
}
}
compare <- data.frame(metadata = metadata$sample, spectra = metadata$spectra)
for(i in 1:length(metadata$sample)) {
if(length(positions[[i]]) == 1){
metadata$spectra.index[i] <- positions[[i]]
}else{
metadata$spectra.index[i] <- NA
}
}
leaves.index <- which(grepl(paste0('(?=.*','L',')'),metadata$class,perl = T))
leaves.index
metadata.leaves <- metadata[leaves.index,]
head(metadata.leaves)
which(is.na(metadata.leaves$Si))
which(is.na(metadata.leaves$spectra))
metadata.leaves$sample[11]
metadata.leaves.Si <- metadata.leaves[-c(11),]
LeavesSi <- cbind(metadata.leaves.Si$sample,metadata.leaves.Si$Si)
leavesSiSpectra <- corrected[metadata.leaves.Si$spectra.index,]
for (i in 1:length(rownames(leavesSiSpectra))){
plot(as.numeric(colnames(leavesSiSpectra)),
leavesSiSpectra[i,],
xlab = '',
ylab = '',
axes = F,
type = 'l',
xlim = c(1700,400),
ylim = c(0,0.06))
par(new = T)
}
box()
axis(1)
axis(2)
title(main = '',
xlab = expression(paste('Wave number (cm'^'-1',')')),
ylab = 'Absorbance (a.u.)')
leavesSiSpectra <- as.matrix(leavesSiSpectra)
SiTable <- data.frame(Si = I(metadata.leaves.Si$Si),spectra = I(leavesSiSpectra) )
library(pls)
SiPLS <- plsr(SiTable$Si~ leavesSiSpectra,
ncomp = 10,
data = SiTable,
validation = 'LOO')
plot(RMSEP(SiPLS),type="b",legendpos="topright")
plot(SiPLS,ncomp=5,line=TRUE)
any(SiTable$Si<0)
plot(SiPLS,plottype="scores",comps=1:4)
barplot(explvar(SiPLS)[1:4])
any(leavesSiSpectra < 0)
library(subselect)
Hmat <- lmHmat(leavesSiSpectra,metadata.leaves.Si$Si)
gen <- genetic(Hmat$mat, kmin =4, kmax = 15, H= Hmat$H, r =1, crit = 'CCR12', force = T)
View(leavesSiSpectra[,gen$bestsets[12,]])
negatives <- vector('list', nrow(gen$bestsets))
for(i in 1:nrow(gen$bestsets)){
df <- data.frame(leavesSiSpectra[, gen$bestsets[i,]])
has.neg <- apply(df, 2, function(col) any(col < 0))
negatives[[i]] <- which(has.neg)
}
negatives
par(mfrow=c(3,4))
for(j in 1:nrow(gen$bestsets)){
for (i in 1:length(rownames(leavesSiSpectra))){
plot(as.numeric(colnames(leavesSiSpectra)),
leavesSiSpectra[i,],
xlab = '',
ylab = '',
axes = F,
type = 'l',
xlim = c(1700,400),
ylim = c(0,0.06))
par(new = T)
}
box()
axis(1)
axis(2)
title(main = '',
xlab = expression(paste('Wave number (cm'^'-1',')')),
ylab = 'Absorbance (a.u.)')
abline(h = as.numeric(colnames(leavesSiSpectra)[gen$bestsets[i,]]),
col = 2,
lty = 2)
par(mfrow=c(3,4))
for(j in 1:nrow(gen$bestsets)){
for (i in 1:length(rownames(leavesSiSpectra))){
plot(as.numeric(colnames(leavesSiSpectra)),
leavesSiSpectra[i,],
xlab = '',
ylab = '',
axes = F,
type = 'l',
xlim = c(1700,400),
ylim = c(0,0.06))
par(new = T)
}
box()
axis(1)
axis(2)
title(main = '',
xlab = expression(paste('Wave number (cm'^'-1',')')),
ylab = 'Absorbance (a.u.)')
abline(h = as.numeric(colnames(leavesSiSpectra)[gen$bestsets[i,]]),
col = 2,
lty = 2)
}
par(mfrow=c(3,4))
for(j in 1:nrow(gen$bestsets)){
for (i in 1:length(rownames(leavesSiSpectra))){
plot(as.numeric(colnames(leavesSiSpectra)),
leavesSiSpectra[i,],
xlab = '',
ylab = '',
axes = F,
type = 'l',
xlim = c(1700,400),
ylim = c(0,0.06))
par(new = T)
}
box()
axis(1)
axis(2)
title(main = '',
xlab = expression(paste('Wave number (cm'^'-1',')')),
ylab = 'Absorbance (a.u.)')
abline(h = as.numeric(colnames(leavesSiSpectra)[gen$bestsets[j,]]),
col = 2,
lty = 2)
}
+par(mfrow=c(3,4))
par(mfrow=c(3,4))
for(j in 1:nrow(gen$bestsets)){
for (i in 1:length(rownames(leavesSiSpectra))){
plot(as.numeric(colnames(leavesSiSpectra)),
leavesSiSpectra[i,],
xlab = '',
ylab = '',
axes = F,
type = 'l',
xlim = c(1700,400),
ylim = c(0,0.06))
par(new = T)
}
box()
axis(1)
axis(2)
title(main = paste(as.character(c(4:15)[j]),'variables'),
xlab = expression(paste('Wave number (cm'^'-1',')')),
ylab = 'Absorbance (a.u.)')
abline(v = as.numeric(colnames(leavesSiSpectra)[gen$bestsets[j,]]),
col = 2,
lty = 2)
}
View(gen)
0.96*nrow(leavesSiSpectra)
nrow(leavesSiSpectra)
summary(mols)
mols <- lm(metadata.leaves.Si$Si ~ leavesSiSpectra[,gen$bestsets[1,]], y = T, x = T)
summary(mols)
mols <- lm(metadata.leaves.Si$Si ~ leavesSiSpectra[,gen$bestsets[5,]], y = T, x = T)
summary(mols)
mols <- lm(metadata.leaves.Si$Si ~ leavesSiSpectra[,gen$bestsets[5,][c(2,3,6)]], y = T, x = T)
summary(mols)
gen$bestsets[5,][c(2,3,6)]
colnames(leavesSiSpectra)[gen$bestsets[5,][c(2,3,6)]]
mols <- lm(metadata.leaves.Si$Si ~ leavesSiSpectra[,gen$bestsets[5,]], y = T, x = T)
summary(mols)
library(pls)
SiPLSgen <- plsr(SiTable$Si~ leavesSiSpectra[,gen$bestsets[5,]], ncomp = 10,
data = SiTable,
validation = 'LOO')
library(pls)
SiPLSgen <- plsr(SiTable$Si~ leavesSiSpectra[,gen$bestsets[5,]],
data = SiTable,
validation = 'LOO')
plot(RMSEP(SiPLSgen),type="b",legendpos="topright")
plot(SiPLS,ncomp=10,line=TRUE)
predictions8Var <- predict(mols,  newdata = SiTable)
predictions8Var[,1,1]
predictions8Var
predictions8Var <- predict(mols,  newdata = SiTable)
predX8Var <- SiTable$Si
predY8var <- predictions8Var
table8bar <- data.frame(I( predX8Var),I(predY8var))
lm.C <- lm(predX8Var~predY8var)
sum(lm.C)
summary(lm.C)
predictions8Var <- predict(mols,  newdata = SiTable)
predX8Var <- SiTable$Si
predY8var <- predictions8Var
table8bar <- data.frame(I( predX8Var),I(predY8var))
lm.C <- lm(predX8Var~predY8var)
plot(predX8Var,
predY8var,
xlab="Si real (ppm)" ,
ylab="Si predicho (ppm)",
pch=17,
cex=1.2,
col="darkorchid4",
cex.lab=1
)
abline(a=-5.856e-10  , b=1, col=1, lty=1, lwd=2)
# legend("topleft", recta.restado, pch=pch ,col=colfin, cex=1)
mols <- lm(metadata.leaves.Si$Si ~ leavesSiSpectra[,gen$bestsets[12,]], y = T, x = T)
predictions8Var <- predict(mols,  newdata = SiTable)
predX8Var <- SiTable$Si
predY8var <- predictions8Var
table8bar <- data.frame(I( predX8Var),I(predY8var))
lm.C <- lm(predX8Var~predY8var)
plot(predX8Var,
predY8var,
xlab="Si real (ppm)" ,
ylab="Si predicho (ppm)",
pch=17,
cex=1.2,
col="darkorchid4",
cex.lab=1
)
abline(a=-5.856e-10  , b=1, col=1, lty=1, lwd=2)
# legend("topleft", recta.restado, pch=pch ,col=colfin, cex=1)
mols <- lm(metadata.leaves.Si$Si ~ leavesSiSpectra[,gen$bestsets[11,]], y = T, x = T)
mols <- lm(metadata.leaves.Si$Si ~ leavesSiSpectra[,gen$bestsets[10,]], y = T, x = T)
summary(mols)
predictions8Var <- predict(mols,  newdata = SiTable)
predX8Var <- SiTable$Si
predY8var <- predictions8Var
table8bar <- data.frame(I( predX8Var),I(predY8var))
lm.C <- lm(predX8Var~predY8var)
plot(predX8Var,
predY8var,
xlab="Si real (ppm)" ,
ylab="Si predicho (ppm)",
pch=17,
cex=1.2,
col="darkorchid4",
cex.lab=1
)
abline(a=-5.856e-10  , b=1, col=1, lty=1, lwd=2)
# legend("topleft", recta.restado, pch=pch ,col=colfin, cex=1)
View(metadata)
View(metadata.leaves)
View(metadata.leaves.Si)
View(metadata.leaves.Si)
colnames(leavesSiSpectra)
nuevoRango <-   leavesSiSpectra[,c(261:676)]
library(pls)
SiPLS <- plsr(SiTable$Si~ nuevoRango,
ncomp = 10,
data = SiTable,
validation = 'LOO')
plot(SiPLS,ncomp=5,line=TRUE)
library(pls)
SiPLS <- plsr(SiTable$Si~ nuevoRango,
ncomp = 10,
data = SiTable,
validation = 'LOO')
plot(RMSEP(SiPLS),type="b",legendpos="topright")
plot(SiPLS,ncomp=4,line=TRUE)
plot(SiPLS,plottype="scores",comps=1:4)
barplot(explvar(SiPLS)[1:4])
View(gen)
View(leavesSiSpectra[,gen$bestsets[12,]])
mols <- lm(metadata.leaves.Si$Si ~ leavesSiSpectra[,gen$bestsets[12,]], y = T, x = T)
summary(mols)
predictions8Var <- predict(mols,  newdata = SiTable)
predX8Var <- SiTable$Si
predY8var <- predictions8Var
table8bar <- data.frame(I( predX8Var),I(predY8var))
lm.C <- lm(predX8Var~predY8var)
plot(predX8Var,
predY8var,
xlab="Si real (ppm)" ,
ylab="Si predicho (ppm)",
pch=17,
cex=1.2,
col="darkorchid4",
cex.lab=1
)
abline(a=-5.856e-10  , b=1, col=1, lty=1, lwd=2)
# legend("topleft", recta.restado, pch=pch ,col=colfin, cex=1)
library(pls)
SiPLSgen <- plsr(SiTable$Si~ leavesSiSpectra[,gen$bestsets[5,]],
data = SiTable,
validation = 'LOO')
plot(RMSEP(SiPLSgen),type="b",legendpos="topright")
library(pls)
SiPLSgen <- plsr(SiTable$Si~ leavesSiSpectra[,gen$bestsets[12,]],
data = SiTable,
validation = 'LOO')
plot(RMSEP(SiPLSgen),type="b",legendpos="topright")
plot(SiPLS,ncomp=3,line=TRUE)
plot(SiPLS,ncomp=4,line=TRUE)
plot(SiPLS,ncomp=15,line=TRUE)
plot(SiPLS,ncomp=10,line=TRUE)
mols <- lm(metadata.leaves.Si$Si ~ leavesSiSpectra[,gen$bestsets[1,]], y = T, x = T)
summary(mols)
predictions8Var <- predict(mols,  newdata = SiTable)
predX8Var <- SiTable$Si
predY8var <- predictions8Var
table8bar <- data.frame(I( predX8Var),I(predY8var))
lm.C <- lm(predX8Var~predY8var)
plot(predX8Var,
predY8var,
xlab="Si real (ppm)" ,
ylab="Si predicho (ppm)",
pch=17,
cex=1.2,
col="darkorchid4",
cex.lab=1
)
abline(a=-5.856e-10  , b=1, col=1, lty=1, lwd=2)
# legend("topleft", recta.restado, pch=pch ,col=colfin, cex=1)
mols <- lm(metadata.leaves.Si$Si ~ leavesSiSpectra[,gen$bestsets[2,]], y = T, x = T)
summary(mols)
predictions8Var <- predict(mols,  newdata = SiTable)
predX8Var <- SiTable$Si
predY8var <- predictions8Var
table8bar <- data.frame(I( predX8Var),I(predY8var))
lm.C <- lm(predX8Var~predY8var)
plot(predX8Var,
predY8var,
xlab="Si real (ppm)" ,
ylab="Si predicho (ppm)",
pch=17,
cex=1.2,
col="darkorchid4",
cex.lab=1
)
abline(a=-5.856e-10  , b=1, col=1, lty=1, lwd=2)
# legend("topleft", recta.restado, pch=pch ,col=colfin, cex=1)
colnames(leavesSiSpectra)[gen$bestsets[3,]]
mols <- lm(metadata.leaves.Si$Si ~ leavesSiSpectra[,gen$bestsets[3,]], y = T, x = T)
summary(mols)
predictions8Var <- predict(mols,  newdata = SiTable)
predX8Var <- SiTable$Si
predY8var <- predictions8Var
table8bar <- data.frame(I( predX8Var),I(predY8var))
lm.C <- lm(predX8Var~predY8var)
plot(predX8Var,
predY8var,
xlab="Si real (ppm)" ,
ylab="Si predicho (ppm)",
pch=17,
cex=1.2,
col="darkorchid4",
cex.lab=1
)
abline(a=-5.856e-10  , b=1, col=1, lty=1, lwd=2)
# legend("topleft", recta.restado, pch=pch ,col=colfin, cex=1)
